name: image-bot

on:
  workflow_dispatch:
  schedule:
    # JST 00/06/08/12/16/20 â†’ UTC 15/21/23/03/07/11
    - cron: "0 15 * * *"
    - cron: "0 21 * * *"
    - cron: "0 23 * * *"
    - cron: "0 3 * * *"
    - cron: "0 7 * * *"
    - cron: "0 11 * * *"

jobs:
  scraper:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - name: Install system deps (dlib/face_recognition)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libopenblas-dev liblapack-dev libjpeg-dev
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install Python deps
        run: pip install -r requirements.txt
      - name: Run scraper
        env:
          TWITTER_CONSUMER_KEY: ${{ secrets.TWITTER_CONSUMER_KEY }}
          TWITTER_CONSUMER_SECRET: ${{ secrets.TWITTER_CONSUMER_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: |
          mkdir -p logs images state
          python scraper.py --out-dir images --reference-dir MEGAFON_noka --log-file logs/scrape.log
      - name: Commit and push scraped images
        if: github.event_name != 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add images state/history.json state/usage.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore: update scraped images ($(date -u +%Y-%m-%d))"
          git push origin HEAD:${GITHUB_REF_NAME}
      - name: Upload logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scraper-logs
          path: logs/scrape.log
          if-no-files-found: ignore

  bot:
    runs-on: ubuntu-latest
    needs: scraper
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - name: Install system deps (dlib/face_recognition)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libopenblas-dev liblapack-dev libjpeg-dev
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install Python deps
        run: pip install -r requirements.txt
      - name: Run bot (skip if no secrets or no images)
        env:
          TWITTER_CONSUMER_KEY: ${{ secrets.TWITTER_CONSUMER_KEY }}
          TWITTER_CONSUMER_SECRET: ${{ secrets.TWITTER_CONSUMER_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          SAUCENAO_KEY: ${{ secrets.SAUCENAO_KEY }}
        run: |
          mkdir -p logs state images
          if [ -z "$TWITTER_CONSUMER_KEY" ] || [ -z "$TWITTER_CONSUMER_SECRET" ] || [ -z "$TWITTER_ACCESS_TOKEN" ] || [ -z "$TWITTER_ACCESS_TOKEN_SECRET" ]; then
            echo "Missing Twitter secrets; skipping bot."
            exit 0
          fi
          if [ -z "$(find images -maxdepth 1 -type f \\( -name '*.jpg' -o -name '*.jpeg' -o -name '*.png' -o -name '*.gif' -o -name '*.webp' \\))" ]; then
            echo "No images found; skipping bot."
            exit 0
          fi
          python bot.py --images-dir images --history-file state/history.json --usage-file state/usage.json --log-file logs/bot.log --search-alt
      - name: Commit and push bot state
        if: github.event_name != 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add images state/history.json state/usage.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore: update bot state ($(date -u +%Y-%m-%d))"
          git push origin HEAD:${GITHUB_REF_NAME}
      - name: Upload logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-logs
          path: logs/bot.log
          if-no-files-found: ignore
